<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InfiniteTalk | 空间工坊</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Lucide 图标库 -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- 配置 Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    animation: {
                        'pulse-slow': 'pulse-slow 8s infinite ease-in-out',
                        'scan-slow': 'scan-slow 3s infinite linear',
                        'spin-slow': 'spin 3s linear infinite',
                        'shimmer': 'shimmer 1.5s infinite',
                    },
                    keyframes: {
                        'pulse-slow': {
                            '0%, 100%': { opacity: '0.4', transform: 'scale(1)' },
                            '50%': { opacity: '0.6', transform: 'scale(1.1)' },
                        },
                        'scan-slow': {
                            '0%': { top: '-20%' },
                            '100%': { top: '120%' },
                        },
                        shimmer: {
                            '100%': { transform: 'translateX(100%)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* 自定义滚动条 */
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        body {
            font-family: system-ui, -apple-system, sans-serif;
            overflow: hidden;
            /* 防止页面滚动 */
        }

        /* 玻璃拟态类 */
        .glass-card {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .glass-panel {
            background-color: rgba(20, 20, 25, 0.5);
            backdrop-filter: blur(50px);
            -webkit-backdrop-filter: blur(50px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body class="bg-black text-white min-h-screen selection:bg-white/30 selection:text-white">

    <!-- 沉浸式动态背景 -->
    <div class="absolute inset-0 z-0 pointer-events-none">
        <div
            class="absolute top-[-20%] left-[-10%] w-[70%] h-[70%] bg-purple-900/30 rounded-full blur-[120px] animate-pulse-slow">
        </div>
        <div class="absolute bottom-[-20%] right-[-10%] w-[60%] h-[60%] bg-blue-900/20 rounded-full blur-[120px] animate-pulse-slow"
            style="animation-delay: 2s;"></div>
        <div class="absolute top-[40%] left-[30%] w-[40%] h-[40%] bg-indigo-900/10 rounded-full blur-[100px]"></div>
    </div>

    <!-- 顶部导航 -->
    <header class="sticky top-0 z-50 pt-5 px-6 pb-2">
        <div class="glass-card !rounded-full px-5 h-14 flex items-center justify-between mx-auto max-w-[1800px]">
            <div class="flex items-center gap-3">
                <div
                    class="w-8 h-8 bg-gradient-to-b from-white/20 to-white/5 rounded-full flex items-center justify-center border border-white/20 shadow-inner">
                    <i data-lucide="aperture" class="w-4 h-4 text-white"></i>
                </div>
                <h1 class="text-lg font-medium tracking-wide text-white/90">
                    InfiniteTalk <span class="mx-2 text-white/20 font-light">|</span> <span
                        class="text-white/60 font-light">空间工坊</span>
                </h1>
            </div>
            <div class="flex items-center gap-3">
                <div
                    class="flex items-center gap-2 px-3 py-1 bg-white/5 rounded-full border border-white/10 backdrop-blur-md">
                    <span class="w-1.5 h-1.5 rounded-full bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.5)]"></span>
                    <span class="text-[10px] font-medium text-white/70 uppercase tracking-wider">Online</span>
                </div>
                <div
                    class="w-8 h-8 rounded-full bg-white/10 border border-white/20 flex items-center justify-center text-xs font-medium hover:bg-white/20 cursor-pointer transition-colors">
                    IP
                </div>
            </div>
        </div>
    </header>

    <main class="relative z-10 max-w-[1800px] mx-auto p-5 grid grid-cols-1 lg:grid-cols-12 gap-6 h-[calc(100vh-88px)]">

        <!-- 左侧控制台 (比例调整为 3/12，更窄) -->
        <div class="glass-panel lg:col-span-3 flex flex-col rounded-[1.5rem] overflow-hidden min-w-[320px]">
            <div class="p-5 pb-3 border-b border-white/5">
                <h2 class="text-base font-medium text-white/90 flex items-center gap-2">
                    <i data-lucide="settings-2" class="w-4 h-4 text-white/60"></i>
                    配置
                </h2>
            </div>

            <div class="flex-1 overflow-y-auto p-5 space-y-6 custom-scrollbar">

                <!-- Step 1: Voice Cloning -->
                <section class="space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="text-[10px] font-bold tracking-widest text-white/40 uppercase">01 • 声音克隆</label>
                        <i id="step1-check" data-lucide="check-circle-2" class="w-3.5 h-3.5 text-green-400 hidden"></i>
                    </div>

                    <!-- 未克隆状态 -->
                    <div id="voice-upload-area" onclick="handleCloneVoice()"
                        class="group relative overflow-hidden rounded-xl border border-dashed border-white/20 bg-white/5 hover:bg-white/10 transition-all cursor-pointer h-24 flex flex-col items-center justify-center gap-2">
                        <div id="voice-idle" class="flex flex-col items-center justify-center gap-2 w-full h-full">
                            <div
                                class="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center group-hover:scale-110 transition-transform shadow-lg">
                                <i data-lucide="mic" class="w-4 h-4 text-white"></i>
                            </div>
                            <span class="text-xs font-medium text-white/70">点击克隆声线</span>
                        </div>
                        <div id="voice-loading" class="hidden flex flex-col items-center gap-2">
                            <i data-lucide="refresh-cw" class="w-5 h-5 text-white/80 animate-spin"></i>
                            <span class="text-xs text-white/60">分析中...</span>
                        </div>
                    </div>

                    <!-- 已克隆状态 -->
                    <div id="voice-done-area"
                        class="hidden bg-white/5 rounded-xl p-3 border border-white/10 flex items-center justify-between group hover:border-white/20 transition-all">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center shadow-lg">
                                <i data-lucide="volume-2" class="w-4 h-4 text-white"></i>
                            </div>
                            <div class="overflow-hidden">
                                <div class="text-xs font-medium text-white truncate">用户自有声线.wav</div>
                                <div class="text-[10px] text-white/40">Index 引擎就绪</div>
                            </div>
                        </div>
                        <button onclick="resetVoice()"
                            class="p-1.5 rounded-full hover:bg-white/10 text-white/50 hover:text-white transition-colors">
                            <i data-lucide="refresh-cw" class="w-3.5 h-3.5"></i>
                        </button>
                    </div>
                </section>

                <!-- Step 2: Avatar Selection -->
                <section class="space-y-3">
                    <label class="text-[10px] font-bold tracking-widest text-white/40 uppercase">02 • 视觉形象</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="document.getElementById('file-input').click()"
                            class="aspect-square rounded-xl border border-white/10 bg-white/5 hover:bg-white/10 hover:border-white/30 transition-all flex flex-col items-center justify-center gap-1 group">
                            <i data-lucide="image-plus"
                                class="w-5 h-5 text-white/50 group-hover:text-white transition-colors"></i>
                            <span class="text-[10px] text-white/30 group-hover:text-white/60">上传</span>
                            <input type="file" id="file-input" class="hidden" accept="image/*"
                                onchange="handlePhotoUpload(this)">
                        </button>

                        <!-- Presets (Compact) -->
                        <button
                            onclick="setAvatar('https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop&q=80')"
                            class="aspect-square rounded-xl overflow-hidden relative border-2 border-transparent hover:opacity-100 opacity-60 transition-all group avatar-btn active-avatar">
                            <img src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=200&h=200&fit=crop&q=80"
                                class="w-full h-full object-cover">
                        </button>
                        <button
                            onclick="setAvatar('https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=400&h=600&fit=crop&q=80')"
                            class="aspect-square rounded-xl overflow-hidden relative border-2 border-transparent hover:opacity-100 opacity-60 transition-all group avatar-btn">
                            <img src="https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=200&h=200&fit=crop&q=80"
                                class="w-full h-full object-cover">
                        </button>
                        <button
                            onclick="setAvatar('https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=400&h=600&fit=crop&q=80')"
                            class="aspect-square rounded-xl overflow-hidden relative border-2 border-transparent hover:opacity-100 opacity-60 transition-all group avatar-btn">
                            <img src="https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=200&h=200&fit=crop&q=80"
                                class="w-full h-full object-cover">
                        </button>
                    </div>
                </section>

                <!-- Step 3: Script & Mode -->
                <section class="space-y-3">
                    <div class="flex items-center justify-between">
                        <label class="text-[10px] font-bold tracking-widest text-white/40 uppercase">03 • 内容脚本</label>
                        <div class="bg-white/5 p-0.5 rounded-lg flex border border-white/10">
                            <button id="mode-ai" onclick="setMode('ai')"
                                class="px-2.5 py-1 rounded-md text-[10px] font-medium transition-all flex items-center gap-1 bg-white/20 text-white shadow-sm">
                                <i data-lucide="wand-2" class="w-3 h-3"></i> AI生成
                            </button>
                            <button id="mode-manual" onclick="setMode('manual')"
                                class="px-2.5 py-1 rounded-md text-[10px] font-medium transition-all flex items-center gap-1 text-white/40 hover:text-white/70">
                                <i data-lucide="align-left" class="w-3 h-3"></i> 精准念稿
                            </button>
                        </div>
                    </div>

                    <div class="relative group">
                        <textarea id="script-input" oninput="updateCharCount()"
                            class="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-xs text-white placeholder:text-white/20 focus:outline-none focus:ring-1 focus:ring-white/20 transition-all resize-none font-light h-28 leading-relaxed"
                            placeholder="输入对话主题...">AI如何让老照片开口说话</textarea>
                        <div
                            class="absolute bottom-2 right-2 px-1.5 py-0.5 rounded bg-white/5 backdrop-blur-md border border-white/10 text-white/30 text-[10px]">
                            <span id="char-count">13</span>
                        </div>
                    </div>
                </section>
            </div>

            <div class="p-5 pt-3 border-t border-white/5 bg-black/20 backdrop-blur-md">
                <button id="generate-btn" onclick="handleGenerate()" disabled
                    class="w-full py-3.5 rounded-xl font-medium text-xs tracking-wide transition-all shadow-lg flex items-center justify-center gap-2 relative overflow-hidden group bg-white/5 text-white/30 cursor-not-allowed border border-white/5">
                    <span id="btn-content" class="flex items-center gap-2">
                        请先完成步骤 01
                    </span>
                    <div id="btn-shine"
                        class="hidden absolute inset-0 -translate-x-full bg-gradient-to-r from-transparent via-white/30 to-transparent z-10">
                    </div>
                </button>
            </div>
        </div>

        <!-- 右侧预览 (比例调整为 9/12，更宽阔) -->
        <div class="glass-panel lg:col-span-9 relative flex flex-col group overflow-hidden rounded-[1.5rem]">

            <div class="flex-1 relative bg-black/40 flex items-center justify-center overflow-hidden w-full h-full p-8">

                <!-- Background Blur (Ambilight) -->
                <div id="bg-blur"
                    class="absolute inset-0 bg-cover bg-center opacity-30 blur-[120px] scale-125 transition-all duration-[3s]"
                    style="background-image: url('https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop&q=80')">
                </div>

                <!-- Main Video Area (Dynamic Aspect Ratio) -->
                <!-- 关键修改：移除 aspect-video，使用 h-full 和 object-contain 来适应竖屏人像 -->
                <div id="video-wrapper"
                    class="relative z-20 transition-all duration-700 scale-100 opacity-100 h-full w-full flex items-center justify-center">
                    <div
                        class="relative rounded-2xl overflow-hidden shadow-[0_20px_50px_rgba(0,0,0,0.5)] border border-white/10 h-full w-auto aspect-auto max-w-full bg-black/50">
                        <!-- 图片容器 -->
                        <img id="main-avatar"
                            src="https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=600&h=800&fit=crop&q=80"
                            class="h-full w-auto object-contain transition-transform duration-[4s] ease-in-out">

                        <!-- Overlay Effects -->
                        <div id="play-glow"
                            class="hidden absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent mix-blend-overlay pointer-events-none">
                        </div>
                        <div id="scan-line"
                            class="hidden absolute inset-0 bg-gradient-to-b from-transparent via-white/10 to-transparent h-[15%] w-full animate-scan-slow pointer-events-none backdrop-blur-[1px]">
                        </div>

                        <!-- Play Button Overlay (Centered on image) -->
                        <div id="play-overlay" onclick="togglePlay()"
                            class="absolute inset-0 z-30 flex items-center justify-center cursor-pointer group/play">
                            <div
                                class="w-20 h-20 rounded-full bg-white/10 backdrop-blur-md border border-white/20 flex items-center justify-center transition-all duration-300 group-hover/play:scale-110 group-hover/play:bg-white/20 shadow-[0_0_30px_rgba(255,255,255,0.1)]">
                                <i data-lucide="play" class="w-8 h-8 text-white fill-white ml-1 opacity-90"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Loading State (Moved Outside for Higher Hierarchy) -->
                <div id="loading-overlay"
                    class="hidden absolute inset-0 z-50 flex flex-col items-center justify-center backdrop-blur-md bg-black/40">
                    <div class="w-48 h-1 bg-white/10 rounded-full overflow-hidden mb-4">
                        <div id="progress-bar"
                            class="h-full bg-white shadow-[0_0_10px_white] transition-all duration-300 ease-out"
                            style="width: 0%"></div>
                    </div>
                    <div
                        class="bg-black/40 backdrop-blur-xl px-4 py-2 rounded-full border border-white/10 flex items-center gap-2 shadow-2xl">
                        <i data-lucide="sparkles" class="w-3 h-3 text-white animate-pulse"></i>
                        <span id="loading-text" class="text-xs font-light text-white tracking-wide">初始化...</span>
                    </div>
                </div>

                <!-- Control Bar (Floating Bottom) -->
                <div id="control-bar"
                    class="absolute bottom-8 left-1/2 -translate-x-1/2 h-16 bg-black/60 backdrop-blur-2xl border border-white/10 rounded-full flex items-center px-6 gap-4 z-40 transition-all translate-y-24 opacity-0 shadow-2xl duration-500 min-w-[320px]">
                    <button onclick="togglePlay()"
                        class="w-8 h-8 rounded-full bg-white text-black flex items-center justify-center hover:scale-105 transition-transform">
                        <i id="control-play-icon" data-lucide="play" class="w-3.5 h-3.5 fill-current ml-0.5"></i>
                    </button>

                    <div class="flex-1 flex flex-col justify-center gap-1 min-w-[120px]">
                        <div
                            class="flex justify-between text-[9px] font-medium text-white/50 uppercase tracking-widest">
                            <span id="status-text">暂停</span>
                            <span>00:45</span>
                        </div>
                        <div class="h-1 bg-white/10 rounded-full overflow-hidden cursor-pointer">
                            <div class="h-full bg-white w-[35%] shadow-[0_0_10px_white]"></div>
                        </div>
                    </div>

                    <div class="h-6 w-[1px] bg-white/10"></div>

                    <div class="flex gap-1">
                        <button onclick="downloadResult()"
                            class="p-2 rounded-full hover:bg-white/10 text-white/70 hover:text-white transition-colors"
                            title="下载">
                            <i data-lucide="download" class="w-4 h-4"></i>
                        </button>
                        <button
                            class="p-2 rounded-full hover:bg-white/10 text-white/70 hover:text-white transition-colors"
                            title="全屏">
                            <i data-lucide="maximize" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Script Overlay (Right Top) -->
            <div id="script-overlay"
                class="absolute top-6 right-6 w-72 max-h-[250px] overflow-y-auto bg-black/60 backdrop-blur-xl border border-white/10 rounded-2xl p-4 z-40 custom-scrollbar opacity-0 pointer-events-none transition-opacity duration-300 hover:opacity-100 group-hover:opacity-100">
                <div class="flex items-center gap-2 mb-2 text-white/40 text-[10px] font-bold uppercase tracking-widest">
                    <i data-lucide="file-text" class="w-3 h-3"></i> 生成脚本
                </div>
                <p id="script-content" class="text-xs font-light leading-relaxed text-white/90 whitespace-pre-wrap">
                    <span class="text-white/30 italic">等待生成...</span>
                </p>
            </div>
        </div>
    </main>

    <!-- Logic Script -->
    <script>
        lucide.createIcons();

        let state = {
            isGenerating: false,
            isPlaying: false,
            isCloning: false,
            clonedVoice: null,
            scriptMode: 'ai',
            avatarUrl: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=600&fit=crop&q=80',
            hasGenerated: false,
            currentJobId: null,
            selectedEngine: 'wan2gp'
        };

        const els = {
            voiceIdle: document.getElementById('voice-idle'),
            voiceLoading: document.getElementById('voice-loading'),
            voiceDone: document.getElementById('voice-done-area'),
            voiceUpload: document.getElementById('voice-upload-area'),
            step1Check: document.getElementById('step1-check'),
            mainAvatar: document.getElementById('main-avatar'),
            bgBlur: document.getElementById('bg-blur'),
            generateBtn: document.getElementById('generate-btn'),
            btnContent: document.getElementById('btn-content'),
            btnShine: document.getElementById('btn-shine'),
            scriptInput: document.getElementById('script-input'),
            loadingOverlay: document.getElementById('loading-overlay'),
            progressBar: document.getElementById('progress-bar'),
            loadingText: document.getElementById('loading-text'),
            videoWrapper: document.getElementById('video-wrapper'),
            scanLine: document.getElementById('scan-line'),
            playOverlay: document.getElementById('play-overlay'),
            controlBar: document.getElementById('control-bar'),
            controlPlayIcon: document.getElementById('control-play-icon'),
            scriptContent: document.getElementById('script-content'),
            scriptOverlay: document.getElementById('script-overlay'),
            statusText: document.getElementById('status-text')
        };

        async function api(path, options = {}) {
            const res = await fetch(path, {
                headers: { 'Content-Type': 'application/json' },
                ...options
            });
            if (!res.ok) {
                let detail = '请求失败';
                try {
                    const body = await res.json();
                    detail = body.detail || detail;
                } catch (_) { }
                throw new Error(detail);
            }
            return res.json();
        }

        async function handleCloneVoice() {
            if (state.isCloning) return;
            state.isCloning = true;

            els.voiceIdle.classList.add('hidden');
            els.voiceLoading.classList.remove('hidden');
            els.voiceUpload.classList.add('animate-pulse');

            try {
                const result = await api('/api/voice/clone', { method: 'POST' });
                state.clonedVoice = result.voice_id;
                state.selectedEngine = result.engine;

                els.voiceUpload.classList.add('hidden');
                els.voiceUpload.classList.remove('animate-pulse');
                els.voiceDone.classList.remove('hidden');
                els.step1Check.classList.remove('hidden');
                updateGenerateButton();
            } catch (error) {
                resetVoice();
                alert('声音克隆失败：' + error.message);
            } finally {
                state.isCloning = false;
            }
        }

        function resetVoice() {
            state.clonedVoice = null;
            els.voiceDone.classList.add('hidden');
            els.voiceUpload.classList.remove('hidden');
            els.voiceIdle.classList.remove('hidden');
            els.voiceLoading.classList.add('hidden');
            els.step1Check.classList.add('hidden');
            updateGenerateButton();
        }

        function setAvatar(url) {
            state.avatarUrl = url;
            els.mainAvatar.src = url;
            els.bgBlur.style.backgroundImage = `url('${url}')`;

            document.querySelectorAll('.avatar-btn').forEach(btn => {
                const img = btn.querySelector('img').src;
                if (img.includes(url.split('?')[0])) {
                    btn.classList.add('border-white/80', 'shadow-[0_0_20px_rgba(255,255,255,0.3)]', 'opacity-100');
                    btn.classList.remove('border-transparent', 'opacity-60');
                } else {
                    btn.classList.remove('border-white/80', 'shadow-[0_0_20px_rgba(255,255,255,0.3)]', 'opacity-100');
                    btn.classList.add('border-transparent', 'opacity-60');
                }
            });
        }

        function handlePhotoUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    setAvatar(e.target.result);
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function setMode(mode) {
            state.scriptMode = mode;
            const btnAi = document.getElementById('mode-ai');
            const btnManual = document.getElementById('mode-manual');

            if (mode === 'ai') {
                btnAi.classList.replace('text-white/40', 'bg-white/20');
                btnAi.classList.add('text-white', 'shadow-sm');
                btnManual.classList.remove('bg-white/20', 'text-white', 'shadow-sm');
                btnManual.classList.add('text-white/40');
                els.scriptInput.placeholder = '描述你希望 AI 生成的演讲主题...';
                els.scriptInput.value = '未来科技发布会开场';
            } else {
                btnManual.classList.replace('text-white/40', 'bg-white/20');
                btnManual.classList.add('text-white', 'shadow-sm');
                btnAi.classList.remove('bg-white/20', 'text-white', 'shadow-sm');
                btnAi.classList.add('text-white/40');
                els.scriptInput.placeholder = '请输入或粘贴完整的文案...';
                els.scriptInput.value = '大家好，我是由 InfiniteTalk 生成的数字人。';
            }
            updateCharCount();
        }

        function updateCharCount() {
            document.getElementById('char-count').innerText = els.scriptInput.value.length;
        }

        function updateGenerateButton() {
            if (state.clonedVoice) {
                els.generateBtn.disabled = false;
                els.generateBtn.classList.remove('bg-white/5', 'text-white/30', 'cursor-not-allowed', 'border-white/5');
                els.generateBtn.classList.add('bg-white', 'text-black', 'hover:scale-[1.02]', 'border-white');
                els.btnShine.classList.remove('hidden');
                els.btnShine.classList.add('group-hover:animate-shimmer');
                els.btnContent.innerHTML = `<i data-lucide="monitor-play" class="w-4 h-4"></i><span>生成沉浸体验</span>`;
                lucide.createIcons();
            } else {
                els.generateBtn.disabled = true;
                els.generateBtn.classList.add('bg-white/5', 'text-white/30', 'cursor-not-allowed', 'border-white/5');
                els.generateBtn.classList.remove('bg-white', 'text-black', 'hover:scale-[1.02]', 'border-white');
                els.btnShine.classList.add('hidden');
                els.btnContent.innerText = '请先完成步骤 01';
            }
        }

        function enterGeneratingUI() {
            els.loadingOverlay.classList.remove('hidden');
            els.scanLine.classList.remove('hidden');
            els.videoWrapper.classList.add('scale-95', 'opacity-50', 'blur-sm');
            els.videoWrapper.classList.remove('scale-100', 'opacity-100');
            els.playOverlay.classList.add('hidden');
            els.controlBar.classList.remove('translate-y-0', 'opacity-100');
            els.controlBar.classList.add('translate-y-24', 'opacity-0');
            els.generateBtn.innerHTML = `<div class="w-3 h-3 border-2 border-black/30 border-t-black rounded-full animate-spin"></div><span>处理中...</span>`;
        }

        function leaveGeneratingUI() {
            els.loadingOverlay.classList.add('hidden');
            els.scanLine.classList.add('hidden');
            els.videoWrapper.classList.remove('scale-95', 'opacity-50', 'blur-sm');
            els.videoWrapper.classList.add('scale-100', 'opacity-100');
            updateGenerateButton();
        }

        async function pollJob(jobId) {
            return new Promise((resolve, reject) => {
                const timer = setInterval(async () => {
                    try {
                        const job = await api(`/api/jobs/${jobId}`);
                        els.progressBar.style.width = `${job.progress}%`;

                        // Engine display with fallback indication
                        let engineText = job.selected_engine;
                        if (job.fallback_reason) {
                            engineText += ` (从优先引擎回退)`;
                            els.loadingText.classList.add('text-orange-300'); // Highlight fallback
                        }
                        els.loadingText.innerText = `${job.message} [${engineText}]`;

                        if (job.status === 'completed') {
                            clearInterval(timer);
                            resolve(job);
                        } else if (job.status === 'failed') {
                            clearInterval(timer);
                            reject(new Error(job.message));
                        }
                    } catch (error) {
                        clearInterval(timer);
                        reject(error);
                    }
                }, 500);
            });
        }

        async function handleGenerate() {
            if (state.isGenerating || !state.clonedVoice) return;
            state.isGenerating = true;
            state.isPlaying = false;
            updatePlayState();
            enterGeneratingUI();

            try {
                const created = await api('/api/jobs', {
                    method: 'POST',
                    body: JSON.stringify({
                        voice_id: state.clonedVoice,
                        avatar_url: state.avatarUrl,
                        script_mode: state.scriptMode,
                        script_input: els.scriptInput.value,
                        preferred_engine: 'infinitetalk' // Requesting infinitetalk to trigger fallback demo
                    })
                });
                state.currentJobId = created.job_id;
                const finalJob = await pollJob(created.job_id);
                finishGeneration(finalJob);
            } catch (error) {
                leaveGeneratingUI();
                els.loadingText.classList.remove('text-orange-300'); // Reset
                alert('生成失败：' + error.message);
            } finally {
                state.isGenerating = false;
            }
        }

        function finishGeneration(job) {
            state.hasGenerated = true;
            leaveGeneratingUI();
            els.loadingText.classList.remove('text-orange-300'); // Reset
            els.scriptContent.innerText = job.generated_script || '脚本生成失败';
            els.scriptOverlay.classList.remove('pointer-events-none');
            els.scriptOverlay.style.pointerEvents = 'auto';
            els.playOverlay.classList.remove('hidden');

            // Notification for fallback
            if (job.fallback_reason) {
                alert(`提示：已自动回退到 [${job.selected_engine}] 兼容模式。\n原因：${job.fallback_reason}`);
            }
        }

        function togglePlay() {
            if (!state.hasGenerated) return;
            state.isPlaying = !state.isPlaying;
            updatePlayState();
        }

        function updatePlayState() {
            if (state.isPlaying) {
                els.mainAvatar.classList.add('scale-110');
                els.mainAvatar.classList.remove('scale-100');
                els.playOverlay.classList.add('hidden');
                els.controlBar.classList.remove('translate-y-24', 'opacity-0');
                els.controlBar.classList.add('translate-y-0', 'opacity-100');
                els.controlPlayIcon.setAttribute('data-lucide', 'pause');
                els.controlPlayIcon.classList.remove('ml-0.5');
                els.statusText.innerText = '播放中';
            } else {
                els.mainAvatar.classList.remove('scale-110');
                els.mainAvatar.classList.add('scale-100');
                if (state.hasGenerated) els.playOverlay.classList.remove('hidden');
                els.controlPlayIcon.setAttribute('data-lucide', 'play');
                els.controlPlayIcon.classList.add('ml-0.5');
                els.statusText.innerText = '暂停';
            }
            lucide.createIcons();
        }

        async function downloadResult() {
            if (!state.currentJobId) return;
            try {
                const result = await api(`/api/jobs/${state.currentJobId}/result`);
                if (result.url) {
                    alert(`模拟文件下载：${result.url}`);
                    // window.open(result.url, '_blank');
                } else {
                    alert('文件尚未就绪');
                }
            } catch (err) {
                alert('获取下载链接失败');
            }
        }

        updateCharCount();
    </script>
</body>

</html>